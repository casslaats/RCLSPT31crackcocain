<!DOCTYPE html>
<meta charset="utf-8"/>
<script src="js/clmtrackr.min.js"></script>
<script src="js/model_pca_20_svm.js"></script>
<link rel="stylesheet" href="css/style.css">

<video id="inputVideo" width="800" height="600" autoplay loop>
</video>
<canvas id="drawCanvas" width="800" height="600"></canvas>

<div id="templeDistance">
   
</div>
<div id ="eyeDistance">

</div>

<!-- Afstand temple/eye -->
<div id ="TOTAL">
  </div>


<script type="text/javascript">
  var videoInput = document.getElementById('inputVideo');
  var positions;
  var distanceMouth;
  var i = 0;
  var ctracker = new clm.tracker();
  var averageValue = [];
  var shapeValue = 0;
  var timer = 0;
  ctracker.init(pModel);
  ctracker.start(videoInput);
  getVideo();
  drawLoop();
 

   //DRAW CANVAS 
  
  function drawLoop() {
    positions = ctracker.getCurrentPosition();  

    var canvasInput = document.getElementById('drawCanvas');
    var cc = canvasInput.getContext('2d');
    
    requestAnimationFrame(drawLoop);
    var pos1 = positions[0];
    var pos7 = positions[7];

    var pos14 = positions[14];

    var pos25 = positions[25];
    var pos27 = positions[27];

    var pos30 = positions[30];
    var pos32 = positions[32];

    var pos44 = positions[44];
    var pos50 = positions[50];
    
    cc.strokeStyle = "#FF000F";

    cc.clearRect(0, 0, canvasInput.width, canvasInput.height);
    cc.beginPath();
    cc.moveTo(pos44[0], pos44[1]);
    cc.lineTo(pos50[0],pos50[1]);
    cc.closePath();
    cc.stroke();

    cc.strokeStyle = "#91FF00";
    cc.beginPath();
    cc.moveTo(pos27[0],pos27[1]);
    cc.lineTo(pos32[0],pos32[1]);
    cc.closePath();
    cc.stroke();

/*GET DISTANCE OF CERTAIN POINTS*/
    distanceMouth = lineDistance(pos44[0],pos44[1],pos50[0],pos50[1]);
    var templeDistance = document.getElementById('templeDistance');
    templeDistance.innerHTML = distanceMouth;

    distanceEyes = lineDistance(pos27[0],pos27[1],pos32[0],pos32[1]);
    var eyeDistance = document.getElementById('eyeDistance');
    eyeDistance.innerHTML = distanceEyes;

    var total = document.getElementById('TOTAL');  
    shapeValue = getAverageValue(distanceMouth / distanceEyes);
    total.innerHTML = shapeValue;
    

    timer++;
    if(timer == 400){
      getShape(shapeValue);
    }
      // if(shape == "triangle"){


      // }

      // else if(shape == "square"){

        
      // }
      // else if(shape == "circle"){

        
      // }

  }


/*ACCES LIVE VIDEO*/
  function getVideo(){
    var stream;
    var video = document.getElementById('inputVideo');

    navigator.webkitGetUserMedia(
      {video: true, audio: false}, // Options
      function(localMediaStream) { // Success
        stream = localMediaStream;
        video.src = window.URL.createObjectURL(stream);
      },
      function(err) { // Failure
        alert('getUserMedia failed: Code ' + err.code);
      }
    );
  }

/*CALCULATE DISTANCE BETWEEN 2 POINTS*/
  function lineDistance( x1,y1,x2,y2 )
    {
      var distance = 0;

      if(y1 == y2){
        distance = x2 - x1;
      }
      else{
        var A = Math.abs(y2-y1);
        var B = Math.abs(x2-x1);
        var C = (A*A)+(B*B);
        distance = Math.sqrt(C);
        // if(i <11 ){
        //   console.log(A,B,C);
        //   i++;
        // }
      }
      return distance;
    }

/*CALCULATE AVERAGE VALUE OF AN ARRAY*/
    function getAverageValue(value){
      averageValue.unshift(value);
      averageValue = averageValue.slice(0,1000);
      var average = 0;
      for (var x= 0 ; x<averageValue.length; x++){
          average = average + averageValue[x];
      }
      // console.log(averageValue.length);
      // console.log(average);
      average = average/averageValue.length;
      return average;
    }

    function getShape(faceShape){
      if (faceShape < 0.77){
         console.log("triangle");
       } 
       else if (faceShape >= 0.77 && faceShape< 0.9){
         console.log("square");
       } 
       else if (faceShape >= 0.9){
         console.log("circle");
      }
    }

</script>